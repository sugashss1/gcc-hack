{% extends "base.html" %}

{% block title %}Tasks{% endblock %}

{% block content %}

<div>
  <h1 style="color: #111827; margin-bottom: 8px; font-size: 28px; font-weight: 600; letter-spacing: -0.5px;">Kanban Board</h1>
  <p style="color: #6b7280; margin-bottom: 24px; font-size: 14px;">Drag and drop to update status. Total: <span id="taskCount" style="font-weight: 700; color: #1f2937;">0</span> tasks</p>

  <!-- KANBAN BOARD -->
  <div class="kanban">
    <div class="column">
      <h3>üìå TODO</h3>
      <div id="todo" class="task-column"></div>
    </div>

    <div class="column">
      <h3>‚ö° IN PROGRESS</h3>
      <div id="in_progress" class="task-column"></div>
    </div>

    <div class="column">
      <h3>‚úÖ DONE</h3>
      <div id="done" class="task-column"></div>
    </div>
  </div>
</div>

<style>
  .task-tooltip {
    position: relative;
    display: inline-block;
    cursor: pointer;
    width: 100%;
  }

  .task-tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: #2c3e50;
    color: #fff;
    text-align: left;
    padding: 10px 12px;
    border-radius: 6px;
    position: absolute;
    z-index: 10;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 12px;
    line-height: 1.5;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .task-tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }

  .task button {
    margin-top: 10px;
    padding: 6px 10px;
    font-size: 12px;
    cursor: pointer;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    transition: all 0.3s ease;
    font-weight: 600;
  }

  .task button:hover {
    background: #c0392b;
    transform: scale(1.05);
  }
</style>

<script>
  const role = "{{ session.get('role') }}";
  
  /* Load & render tasks */
  async function loadTasks() {
    console.log("Loading tasks for role:", role);
    const res = await fetch("/api/tasks");
    const tasks = await res.json();
    console.log("Loaded", tasks.length, "tasks:", tasks);
    document.getElementById("taskCount").textContent = tasks.length;
    render(tasks);
  }

  function render(tasks) {
    console.log("Rendering", tasks.length, "tasks in Kanban board");
    ["todo", "in_progress", "done"].forEach(id => {
      document.getElementById(id).innerHTML = "";
    });

    tasks.forEach(task => {
      const el = document.createElement("div");
      el.className = "task";
      el.draggable = true;

      el.ondragstart = e => {
        e.dataTransfer.setData("id", task.id);
      };

      const tooltipWrapper = document.createElement("div");
      tooltipWrapper.className = "task-tooltip";

      tooltipWrapper.innerHTML = `
        <strong>${task.title}</strong>
        <div style="margin-top: 6px;">
          <small style="color: #95a5a6; display: block;">üìÅ ${task.project_name || "-"}</small>
          <small style="color: #95a5a6; display: block;">üë§ ${task.assigned_to || "-"}</small>
        </div>
        <span class="tooltiptext">${task.description || "No description"}</span>
      `;

      if ((task.status || "TODO").toUpperCase() === "DONE" && role !== "user") {
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è Delete";
        deleteBtn.onclick = async () => {
          if (confirm("Are you sure you want to delete this task?")) {
            await fetch(`/api/tasks/${task.id}`, { method: "DELETE" });
            loadTasks();
          }
        };
        tooltipWrapper.appendChild(deleteBtn);
      }

      el.appendChild(tooltipWrapper);

      const columnId = (task.status || "TODO").toLowerCase();
      const column = document.getElementById(columnId);
      if (column) column.appendChild(el);
    });
  }

  /* Update status via drag & drop */
  async function updateStatus(id, status) {
    await fetch(`/api/tasks/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
  }

  document.querySelectorAll(".task-column").forEach(col => {
    col.ondragover = e => e.preventDefault();
    col.ondrop = async e => {
      const id = e.dataTransfer.getData("id");
      await updateStatus(id, col.id.toUpperCase());
      loadTasks();
    };
  });

  loadTasks();
</script>

{% endblock %}
