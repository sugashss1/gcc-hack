{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto;">
  <h1 style="color: #2c3e50; margin-bottom: 8px; font-size: 32px; font-weight: 700;">Dashboard</h1>
  <p style="color: #7f8c8d; margin-bottom: 32px; font-size: 14px;">Welcome back, <strong>{{ name }}</strong> • Role: <span style="background: #f0f3ff; color: #3498db; padding: 2px 8px; border-radius: 4px; font-weight: 600;">{{ role }}</span></p>
  
  <!-- Quick Stats Row -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #3498db;">
      <div style="font-size: 12px; color: #7f8c8d; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Total Tasks</div>
      <div style="font-size: 28px; font-weight: 700; color: #2c3e50;" id="totalTasksCount">0</div>
    </div>
    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #2ecc71;">
      <div style="font-size: 12px; color: #7f8c8d; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Completed</div>
      <div style="font-size: 28px; font-weight: 700; color: #2ecc71;" id="completedTasksCount">0</div>
    </div>
    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #f39c12;">
      <div style="font-size: 12px; color: #7f8c8d; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">In Progress</div>
      <div style="font-size: 28px; font-weight: 700; color: #f39c12;" id="inProgressTasksCount">0</div>
    </div>
    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #9b59b6;">
      <div style="font-size: 12px; color: #7f8c8d; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Total Projects</div>
      <div style="font-size: 28px; font-weight: 700; color: #9b59b6;" id="totalProjectsCount">0</div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <!-- Task Status Distribution -->
    <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <h3 style="margin: 0 0 20px; color: #2c3e50; font-size: 16px; font-weight: 700;">Task Status</h3>
      <canvas id="taskStatusChart" style="max-height: 220px;"></canvas>
    </div>

    <!-- Tasks by Person -->
    <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <h3 style="margin: 0 0 20px; color: #2c3e50; font-size: 16px; font-weight: 700;">Team Workload</h3>
      <canvas id="tasksByPersonChart" style="max-height: 220px;"></canvas>
    </div>

    <!-- Completion Rate -->
    <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <h3 style="margin: 0 0 20px; color: #2c3e50; font-size: 16px; font-weight: 700;">Completion Rate</h3>
      <canvas id="completionRateChart" style="max-height: 220px;"></canvas>
    </div>
  </div>

  {% if role != "user" %}
    <div style="background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 32px;">
      <a href="/admin/users/create" style="display: inline-block; padding: 10px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 12px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">➕ Create User</a>
    </div>
  {% endif %}

  <!-- CREATE TASK FORM -->
  <div id="taskFormContainer" style="display:none; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 32px;">
    <h3 style="color: #2c3e50; margin-bottom: 20px; margin-top: 0; font-size: 16px; font-weight: 700;">Create Task</h3>
    <form id="taskForm">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Project</label>
          <select name="project_name" id="projectSelect" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
            <option value="">Select project...</option>
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Title</label>
          <input type="text" name="title" placeholder="Task title" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Assign To</label>
          <select name="assigned_to" id="assignedSelect" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
            <option value="">Select person...</option>
          </select>
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Start Date</label>
          <input type="date" name="start_date" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Due Date</label>
          <input type="date" name="due_date" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
      </div>
      <div style="margin-top: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Description</label>
        <textarea name="description" placeholder="Task description" style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px; min-height: 80px; font-family: inherit;"></textarea>
      </div>
      <button type="submit" style="margin-top: 16px; padding: 10px 16px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">Create Task</button>
    </form>
  </div>

  <!-- CREATE PROJECT FORM -->
  <div id="projectFormContainer" style="display:none; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    <h3 style="color: #2c3e50; margin-bottom: 20px; margin-top: 0; font-size: 16px; font-weight: 700;">Create Project</h3>
    <form id="projectForm">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Project Name</label>
          <input type="text" name="project_name" placeholder="Project name" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Start Date</label>
          <input type="date" name="start_date" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Due Date</label>
          <input type="date" name="due_date" required style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
        </div>
        <div id="managerSelectContainer" style="display:none;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Manager</label>
          <select name="manager_id" id="managerSelect" style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px;">
            <option value="">Select manager...</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">Description</label>
        <textarea name="description" placeholder="Project description" style="width: 100%; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 13px; min-height: 80px; font-family: inherit;"></textarea>
      </div>
      <button type="submit" style="margin-top: 16px; padding: 10px 16px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">Create Project</button>
    </form>
  </div>

  <!-- ADD TASK FORM -->
  <div id="taskFormContainer" style="display:none;">
    <h2 style="color: #111827; margin-bottom: 18px; margin-top: 28px; font-size: 18px; font-weight: 600;">Create Task</h2>
    <form id="taskForm">
      <div>
        <label>Project</label>
        <select name="project_name" required id="projectSelect">
          <option value="">Loading...</option>
        </select>
      </div>

      <div>
        <label>Title</label>
        <input type="text" name="title" placeholder="Task title" required>
      </div>

      <div>
        <label>Description</label>
        <textarea name="description" placeholder="Description"></textarea>
      </div>
      
      <div>
        <label>Assign To</label>
        <select name="assigned_to" id="assignedSelect" required>
          <option value="">Select...</option>
        </select>
      </div>

      <div>
        <label>Start</label>
        <input type="date" name="start_date" required>
      </div>

      <div>
        <label>Due</label>
        <input type="date" name="due_date" required>
      </div>

      <button type="submit">Create</button>
    </form>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const userRole = "{{ session.get('role') }}";
let taskStatusChart, tasksByPersonChart, completionRateChart;

// =============== DATA LOADING ===============
async function loadDashboardData() {
  console.log("Loading dashboard data for role:", userRole);
  try {
    const tasksRes = await fetch("/api/tasks");
    const projectsRes = await fetch("/api/projects");
    
    if (!tasksRes.ok || !projectsRes.ok) {
      console.error("API error - Tasks OK:", tasksRes.ok, "Projects OK:", projectsRes.ok);
      throw new Error("Failed to fetch data");
    }
    
    const tasks = await tasksRes.json();
    const projects = await projectsRes.json();

    console.log("Fetched tasks:", tasks.length, tasks);
    console.log("Fetched projects:", projects.length, projects);

    // Update stat cards
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.status === "DONE").length;
    const inProgressTasks = tasks.filter(t => t.status === "IN_PROGRESS").length;
    const totalProjects = projects.length;

    console.log(`Dashboard Stats - Total: ${totalTasks}, Completed: ${completedTasks}, In Progress: ${inProgressTasks}, Projects: ${totalProjects}`);

    document.getElementById("totalTasksCount").textContent = totalTasks;
    document.getElementById("completedTasksCount").textContent = completedTasks;
    document.getElementById("inProgressTasksCount").textContent = inProgressTasks;
    document.getElementById("totalProjectsCount").textContent = totalProjects;

    // Render charts with a slight delay to ensure DOM is ready
    setTimeout(() => {
      renderTaskStatusChart(tasks);
      renderTasksByPersonChart(tasks);
      renderCompletionRateChart(tasks);
    }, 100);
  } catch (error) {
    console.error("Error loading dashboard data:", error);
  }
}

// =============== CHART RENDERING ===============
function renderTaskStatusChart(tasks) {
  console.log("Rendering task status chart with", tasks.length, "tasks");
  
  const statusCounts = { "TODO": 0, "IN_PROGRESS": 0, "DONE": 0 };
  tasks.forEach(task => {
    const status = (task.status || "TODO").toUpperCase();
    if (statusCounts.hasOwnProperty(status)) {
      statusCounts[status]++;
    }
  });

  console.log("Status breakdown:", statusCounts);

  const canvas = document.getElementById('taskStatusChart');
  if (!canvas) {
    console.error("taskStatusChart canvas not found");
    return;
  }

  const ctx = canvas.getContext('2d');
  
  if (taskStatusChart) {
    taskStatusChart.destroy();
  }
  
  taskStatusChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["TODO", "IN PROGRESS", "DONE"],
      datasets: [{
        label: 'Tasks',
        data: [statusCounts["TODO"], statusCounts["IN_PROGRESS"], statusCounts["DONE"]],
        backgroundColor: ["#f39c12", "#3498db", "#2ecc71"],
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { font: { size: 12, weight: '600' }, color: '#7f8c8d' },
          grid: { drawBorder: false, color: '#ecf0f1' }
        },
        y: {
          ticks: { font: { size: 12, weight: '600' }, color: '#2c3e50' },
          grid: { display: false }
        }
      }
    }
  });
}

function renderTasksByPersonChart(tasks) {
  console.log("Rendering tasks by person chart");
  
  const tasksByPerson = {};
  tasks.forEach(task => {
    const person = task.assigned_to || "Unassigned";
    tasksByPerson[person] = (tasksByPerson[person] || 0) + 1;
  });

  console.log("Task distribution by person:", tasksByPerson);

  const canvas = document.getElementById('tasksByPersonChart');
  if (!canvas) {
    console.error("tasksByPersonChart canvas not found");
    return;
  }

  // Sort by count and take top 8
  const labels = Object.keys(tasksByPerson)
    .sort((a, b) => tasksByPerson[b] - tasksByPerson[a])
    .slice(0, 8);
  const data = labels.map(p => tasksByPerson[p]);

  console.log("Top people:", labels, "counts:", data);

  const ctx = canvas.getContext('2d');
  
  if (tasksByPersonChart) {
    tasksByPersonChart.destroy();
  }
  
  tasksByPersonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.length > 0 ? labels : ["No data"],
      datasets: [{
        label: 'Tasks',
        data: data.length > 0 ? data : [0],
        backgroundColor: "#3498db",
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { font: { size: 11, weight: '600' }, color: '#7f8c8d' },
          grid: { drawBorder: false, color: '#ecf0f1' }
        },
        y: {
          ticks: { font: { size: 11, weight: '600' }, color: '#2c3e50' },
          grid: { display: false }
        }
      }
    }
  });
}

function renderCompletionRateChart(tasks) {
  console.log("Rendering completion rate chart");
  
  if (tasks.length === 0) {
    const canvas = document.getElementById('completionRateChart');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = "14px sans-serif";
      ctx.fillStyle = "#7f8c8d";
      ctx.textAlign = "center";
      ctx.fillText("No tasks yet", canvas.width / 2, canvas.height / 2);
    }
    return;
  }

  const completed = tasks.filter(t => t.status === "DONE").length;
  const rate = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;

  console.log(`Completion: ${completed} completed out of ${tasks.length} total = ${rate}%`);

  const canvas = document.getElementById('completionRateChart');
  if (!canvas) {
    console.error("completionRateChart canvas not found");
    return;
  }

  const ctx = canvas.getContext('2d');
  
  if (completionRateChart) {
    completionRateChart.destroy();
  }
  
  completionRateChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ["Completed", "Remaining"],
      datasets: [{
        data: [rate, 100 - rate],
        backgroundColor: ["#2ecc71", "#ecf0f1"],
        borderColor: ["#fff", "#fff"],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 11, weight: '600' }, padding: 12, usePointStyle: true }
        },
        tooltip: {
          callbacks: {
            label: function(context) { return `${context.label}: ${context.raw}%`; }
          }
        }
      }
    }
  });
}

// =============== TASK MANAGEMENT ===============
async function loadProjects() {
  const res = await fetch("/api/projects");
  const projects = await res.json();
  const select = document.getElementById("projectSelect");
  if (!select) return;
  
  select.innerHTML = '<option value="">Select project...</option>';
  projects.forEach(proj => {
    const opt = document.createElement("option");
    opt.value = proj.project_name;
    opt.textContent = proj.project_name;
    select.appendChild(opt);
  });
}

async function loadAssignedUsers() {
  const res = await fetch("/api/user-by-manager-id");
  const users = await res.json();
  const select = document.getElementById("assignedSelect");
  if (!select) return;
  
  select.innerHTML = '<option value="">Select person...</option>';

  if (users.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No users found";
    select.appendChild(opt);
  } else {
    users.forEach(user => {
      const opt = document.createElement("option");
      opt.value = user.email;
      opt.textContent = user.full_name + " (" + user.email + ")";
      select.appendChild(opt);
    });
  }
}

// Show task form for managers ONLY
if (userRole === "manager") {
  const taskFormContainer = document.getElementById("taskFormContainer");
  if (taskFormContainer) {
    taskFormContainer.style.display = "block";
  }
  
  loadProjects();
  loadAssignedUsers();

  const taskForm = document.getElementById("taskForm");
  if (taskForm) {
    taskForm.addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;

      const payload = {
        project_name: form.project_name.value,
        title: form.title.value,
        description: form.description.value || "",
        assigned_to: form.assigned_to.value,
        start_date: form.start_date.value,
        due_date: form.due_date.value
      };

      const res = await fetch("/api/tasks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        form.reset();
        alert("Task created!");
        await loadProjects();
        await loadAssignedUsers();
        await loadDashboardData();
      } else {
        alert("Failed to create task");
      }
    });
  }
}

// =============== PROJECT MANAGEMENT ===============
async function loadManagers() {
  const res = await fetch("/api/all-user");
  const users = await res.json();
  const select = document.getElementById("managerSelect");
  if (!select) return;
  
  select.innerHTML = '<option value="">Select manager...</option>';

  const managers = users.filter(u => u.role === "manager");
  managers.forEach(user => {
    const opt = document.createElement("option");
    opt.value = user.tenant_id || user.id;
    opt.textContent = `${user.full_name} (${user.email})`;
    select.appendChild(opt);
  });
}

// Show project form for managers/CEOs ONLY
if (userRole === "manager" || userRole === "ceo") {
  const projectFormContainer = document.getElementById("projectFormContainer");
  if (projectFormContainer) {
    projectFormContainer.style.display = "block";
  }

  if (userRole === "ceo") {
    const managerContainer = document.getElementById("managerSelectContainer");
    if (managerContainer) {
      managerContainer.style.display = "block";
    }
    loadManagers();
  }

  const projectForm = document.getElementById("projectForm");
  if (projectForm) {
    projectForm.addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;

      const payload = {
        project_name: form.project_name.value,
        description: form.description.value || "",
        start_date: form.start_date.value,
        due_date: form.due_date.value
      };

      if (userRole === "ceo") {
        payload.manager_id = form.manager_id.value;
      }

      const res = await fetch("/api/projects", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        form.reset();
        alert("Project created!");
        await loadDashboardData();
        await loadProjects();
        if (userRole === "ceo") await loadManagers();
      } else {
        alert("Failed to create project");
      }
    });
  }
}

// =============== INITIALIZATION ===============
console.log("Dashboard initialized for role:", userRole);
// Load data immediately on page load
loadDashboardData();
</script>

{% endblock %}
